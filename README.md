December 11, 2023.

# CVE-2024-6768: Unrecoverable inconsistency in CLFS.sys produces a BSOD without RCE on Windows 10 and 11 with all security updates installed. 

In my previous research on BLFS I was able to achieve RCE in both, but
when changing some values ​​in the POC in which I was working, a BSOD was
produced in the target, which I decided to report.

<https://www.coresecurity.com/core-labs/articles/analysis-cve-2023-28252-clfs-vulnerability>

<https://www.youtube.com/watch?v=N5bcibiDVaw>

<https://www.coresecurity.com/core-labs/articles/understanding-cve-2022-37969-windows-clfs-lpe>

# Common Log File System (CLFS) file format:

To face the analysis, it’s necessary to know the .blf file format, that
is handled by the vulnerable Common Log File System driver called
CLFS.sys and that is in driver’s folder within system32.

More information about this filetype can be found in the links below:

https://www.zscaler.com/blogs/security-research/technical-analysis-windows-clfs-zero-day-vulnerability-cve-2022-37969-part

https://learn.microsoft.com/en-us/windows-hardware/drivers/kernel/introduction-to-the-common-log-file-system

https://github.com/ionescu007/clfs-docs/blob/main/README.md

<https://www.coresecurity.com/core-labs/articles/understanding-cve-2022-37969-windows-clfs-lpe>

# The vulnerability:

The attached PoC produces an unrecoverable inconsistency in CLFS.sys
driver, forcing a call to ***KeBugCheckEx*** which allows an
unprivileged user to produce a BSOD and reboots the system, in
***CClfsLogFcbPhysical::FlushLog+6F2*** version 10.0.19041.3324,
affecting all versions up to the latest version of Windows 10 and
Windows 11 with all updates applied.

![A screenshot of a computer error Description automatically
generated](./media/image1.png)

This is the address in CLFS.sys version 10.0.19041.3324 where the call
to **KeBugCheckEx** is produced

*CClfsLogFcbPhysical::FlushLog+6D5*

*CClfsLogFcbPhysical::FlushLog+6D5 loc_FFFFF8062EED4F35: ;
BugCheckParameter2*

*CClfsLogFcbPhysical::FlushLog+6D5 mov r8d, eax*

*CClfsLogFcbPhysical::FlushLog+6D8 and \[rsp+0A8h+Timeout\], 0*

*CClfsLogFcbPhysical::FlushLog+6DE mov r9, rbx ; BugCheckParameter3*

*CClfsLogFcbPhysical::FlushLog+6E1 mov edx, 3Ah ; ':' ;
BugCheckParameter1*

*CClfsLogFcbPhysical::FlushLog+6E6 mov ecx, 0C1F5h ; BugCheckCode*

*CClfsLogFcbPhysical::FlushLog+6EB mov r10, cs:\_\_imp_KeBugCheckEx*

*CClfsLogFcbPhysical::FlushLog+6F2 **call near ptr nt_KeBugCheckEx***

# Building the PoC:

The BLF file created by the PoC has a crafted value
(**0xffffffff00ff01**) in offset **0x1c10** and is attached with the PoC
with the name **54.blf.**

![A screenshot of a computer Description automatically
generated](./media/image2.png)

This crafted value is in offset 0x38 of **\_CLFS_CLIENT_CONTEXT**
structure and is copied in **CClfsLogFcbPhysical::Initialize** to 0x538
offset of **CClfsLogFcbPhysical** structure.

![](./media/image3.png)

The blue marked zone starts with **cidNode = 0xC1FDF006** is the
**CLFSHASHSYM** structure

After that starting with **cidNode == 0xC1FDF007** is located the
**\_CLFS_CLIENT_CONTEXT** structure

*struct \_CLFS_CLIENT_CONTEXT*

*{*

*CLFS_NODE_ID cidNode;*

*CLFS_CLIENT_ID cidClient;*

*USHORT fAttributes;*

*ULONG cbFlushThreshold;*

*ULONG cShadowSectors;*

*ULONGLONG cbUndoCommitment;*

*LARGE_INTEGER llCreateTime;*

*LARGE_INTEGER llAccessTime;*

*LARGE_INTEGER llWriteTime;*

*CLFS_LSN **lsnOwnerPage;***

*CLFS_LSN lsnArchiveTail;*

*CLFS_LSN lsnBase;*

*CLFS_LSN lsnLast;*

*CLFS_LSN lsnRestart;*

*CLFS_LSN lsnPhysicalBase;*

*CLFS_LSN lsnUnused1;*

*CLFS_LSN lsnUnused2;*

*CLFS_LOG_STATE eState;*

*union*

*{*

*HANDLE hSecurityContext;*

*ULONGLONG ullAlignment;*

*};*

*};*

In offset 0x38 is the field **lsnOwnerPage** which will be filled with
the crafted value **0xffffffff00ff01**

![A screenshot of a computer Description automatically
generated](./media/image4.png)

# BSOD explanation:

After the value is copied to
**struct_CClfsLogFcbPhysical_CClfsLogFcbCommon.lsnOwnerPage.ullOffset**
is used in **UpdateCachedOwnerPage**

The call stack shows it comes from the POC after calling the last call
to CreateLogFile

![A screenshot of a computer Description automatically
generated](./media/image5.png)

This is the address when the POC calls to the point when the crafted
value starts to be used.

![A screen shot of a computer Description automatically
generated](./media/image6.png)

![A screen shot of a computer Description automatically
generated](./media/image7.png)

![A screenshot of a computer Description automatically
generated](./media/image8.png)

Inside AddLsnOffset returns an ulloffset calculated from this crafted
value

![A screenshot of a computer Description automatically
generated](./media/image9.png)

The returned ulloffset is 0xFFFFFFFF00000000

![A screenshot of a computer Description automatically
generated](./media/image10.png)

After that, his value is compared and exits the function
CClfsLogFcbPhysical::UpdateCachedOwnerPage

![A screenshot of a computer Description automatically
generated](./media/image11.png)

After that, it returns to the PoC in user mode, and when exits it calls
**CClfsLogFcbPhysical::FlushLog** when the original crafted ullofset is
used

![A screenshot of a computer Description automatically
generated](./media/image12.png)

Is compared in a loop and if is not equal in any cycle as the system is
in unrecoverable state it calls to

KeBugCheck that produces a BSOD to restart itself.

![A screenshot of a computer program Description automatically
generated](./media/image13.png)

![A screenshot of a computer screen Description automatically
generated](./media/image14.png)

# SOURCES AND POC used:

PoC with sources and crafted BLF

[fortra/CVE-2024-6768
(github.com)](https://github.com/fortra/CVE-2024-6768)

<https://drive.google.com/file/d/1pMf0lE-pJHbIj32-jpSlV6Lo2YAkhJXj/view?usp=drive_link>

(passwd a)

We hope you find it useful, if you have any doubt can contact us:

Ricardo Narvaja

[Ricardo.narvaja@fortra.com   
](mailto:%20%C2%A0Ricardo.narvaja@fortra.com)[@ricnar456](https://twitter.com/ricnar456)
